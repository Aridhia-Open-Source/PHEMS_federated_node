{{- define "imagePullSecret" }}
{{- $content := "" -}}
  {{- range $v := .Values.acrs -}}
    {{- $content = (printf "%s\"%s\":{\"username\":\"%s\",\"password\":\"%s\",\"email\":\"%s\",\"auth\":\"%s\"}," $content $v.url $v.username $v.password $v.email (printf "%s:%s" $v.username $v.password | b64enc)) -}}
  {{- end }}
  .dockerconfigjson: {{ printf "{\"auths\":{ %s }}" (trimSuffix "," $content) | b64enc }}
{{- end }}

{{- range list .Release.Namespace .Values.namespaces.tasks .Values.namespaces.keycloak -}}
kind: Secret
apiVersion: v1
metadata:
  name: regcred
  namespace: {{ . }}
data:
  {{ template "imagePullSecret" $ }}
type: kubernetes.io/dockerconfigjson
---
{{- end -}}
