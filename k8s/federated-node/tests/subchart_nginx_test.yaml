suite: Reverse proxy subchart
release:
  namespace: federatednode
  name: federatednode
values:
  - values/values-local.yaml
kubernetesProvider:
  scheme:
    v1/Secret:
      gvr:
        version: v1
        resource: secrets
      namespaced: true
    v1/ConfigMap:
      gvr:
        version: v1
        resource: configmaps
      namespaced: true
  objects:
    - apiVersion: v1
      kind: Secret
      metadata:
        name: awscert-config
        namespace: federatednode
      type: Opaque
      data:
        EMAIL_CERT: dGVzdA==
        REGION: dGVzdA==
        ACCOUNT_ID: dGVzdA==
        ROLE_NAME: dGVzdA==
    - apiVersion: v1
      kind: Secret
      metadata:
        name: local-db
        namespace: federatednode
      type: Opaque
      data:
        password: dGVzdA==
    - apiVersion: v1
      kind: Secret
      metadata:
        name: github-app
        namespace: federatednode
      type: Opaque
      data:
        GH_SECRET: dGVzdA==
        GH_CLIENT_ID: dGVzdA==
tests:
  - it: HTTP routes are deployed
    templates:
      - backend-http-route.yaml
      - keycloak-http-route.yaml
      - gateway-api-crds.yaml
    asserts:
      - hasDocuments:
          count: 2
          filterAware: true
        template: keycloak-http-route.yaml
      - hasDocuments:
          count: 1
          filterAware: true
        template: backend-http-route.yaml
  - it: traefik subchart is deployed
    set:
      gatewayApi:
        installCRD: true
    asserts:
      - hasDocuments:
          count: 4
          filterAware: true
        template: gateway-api-crds.yaml
  - it: gateway crd are not deployed
    template: ../charts/traefik/templates/deployment.yaml
    asserts:
      - equal:
          path: metadata.name
          value: federatednode-traefik
  - it: nginx-ingress custom resources are not deployed
    set:
      traefik:
        enabled: false
    templates:
      - backend-http-route.yaml
      - keycloak-http-route.yaml
      - gateway-api-crds.yaml
    asserts:
      - hasDocuments:
          count: 0
          filterAware: true
        template: backend-http-route.yaml
      - hasDocuments:
          count: 0
          filterAware: true
        template: keycloak-http-route.yaml
      - hasDocuments:
          count: 0
          filterAware: true
        template: gateway-api-crds.yaml
